<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .file-item {
            transition: transform 0.2s;
        }

        .file-item:hover {
            transform: translateX(5px);
        }

        .file-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .file-meta {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .file-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 8px;
        }

        .badge-video {
            background-color: #e7f3ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }

        .badge-audio {
            background-color: #fff3e0;
            color: #e65100;
            border: 1px solid #ffcc80;
        }

        .progress {
            height: 30px;
            border-radius: 10px;
        }

        .progress-bar {
            font-weight: bold;
            line-height: 30px;
        }

        #progress-container {
            display: none;
        }

        .validation-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }

        .validation-feedback.success {
            background-color: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }

        .validation-feedback.error {
            background-color: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }

        .validation-feedback.loading {
            background-color: #cff4fc;
            color: #055160;
            border: 1px solid #b6effb;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Header Card -->
        <div class="card mb-4">
            <div class="card-header text-center">
                <h2 class="mb-0"><i class="bi bi-youtube"></i> YouTube Downloader</h2>
                <p class="mb-0 mt-2">Download videos and audio easily</p>
            </div>
            <div class="card-body p-4">
                <!-- Info Alert -->
                <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <div>
                        <strong>Supports:</strong> Single videos, Playlists, and Channels from YouTube and other platforms
                    </div>
                </div>

                <form id="download-form">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                                <input type="text" id="url-input" name="url" class="form-control" placeholder="Enter video URL..." required>
                            </div>
                        </div>
                        <div class="col-12 col-md-3">
                            <select id="format-select" name="format" class="form-select">
                                <option value="best">Best (No Conversion)</option>
                                <option value="mp4-720p">MP4 Video (≤720p)</option>
                                <option value="mp4-480p">MP4 Video (≤480p)</option>
                                <option value="mp4-360p">MP4 Video (≤360p)</option>
                                <option value="mp4-240p">MP4 Video (≤240p)</option>
                                <option value="webm">WebM Video (Fast)</option>
                                <option value="m4a">M4A Audio</option>
                                <option value="mp3">MP3 Audio</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-download"></i> Download
                            </button>
                        </div>
                    </div>
                </form>

                <div id="validation-feedback" class="validation-feedback"></div>

                <div id="progress-container" class="mt-3">
                    <div class="progress">
                        <div id="progress-fill" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Files List Card -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-folder2-open"></i> Downloaded Files</h5>
                {% if files %}
                <button id="clear-all-btn" class="btn btn-danger btn-sm" onclick="clearAllFiles()">
                    <i class="bi bi-trash3"></i> Clear All
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if files %}
                <div class="list-group">
                    {% for f in files %}
                    <div class="list-group-item file-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center flex-grow-1">
                            <i class="bi bi-file-earmark-play me-3 fs-4 text-primary"></i>
                            <div class="file-info flex-grow-1">
                                <div class="text-break">
                                    {{ f.name }}
                                    {% if f.name.lower().endswith(('.mp4', '.mkv', '.avi', '.mov', '.webm', '.flv')) %}
                                    <span class="file-type-badge badge-video"><i class="bi bi-camera-video-fill"></i> Video</span>
                                    {% elif f.name.lower().endswith(('.m4a', '.mp3', '.aac', '.wav', '.flac', '.ogg', '.opus')) %}
                                    <span class="file-type-badge badge-audio"><i class="bi bi-music-note-beamed"></i> Audio</span>
                                    {% endif %}
                                </div>
                                <div class="file-meta">
                                    <i class="bi bi-hdd"></i> {{ "%.2f"|format(f.size / 1024 / 1024) }} MB
                                    &nbsp;|&nbsp;
                                    <i class="bi bi-calendar3"></i> {{ f.created|int|strftime('%Y-%m-%d %H:%M') }}
                                </div>
                            </div>
                        </div>
                        <div class="btn-group ms-3" role="group">
                            <a href="/download_file/{{ f.name }}" class="btn btn-success btn-sm" download>
                                <i class="bi bi-download"></i> Download
                            </a>
                            <a href="/delete/{{ f.name }}" class="btn btn-danger btn-sm" onclick="return confirm('Delete this file?')">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-3">No files downloaded yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let validationTimeout;
        let isUrlValid = false;
        let currentUrl = '';

        // Real-time URL validation
        document.getElementById('url-input').addEventListener('input', function (e) {
            const url = e.target.value.trim();
            const feedback = document.getElementById('validation-feedback');

            // Clear previous timeout
            clearTimeout(validationTimeout);

            // Reset if empty
            if (!url) {
                feedback.style.display = 'none';
                isUrlValid = false;
                return;
            }

            // Debounce validation
            validationTimeout = setTimeout(() => {
                validateUrl(url);
            }, 800);
        });

        function validateUrl(url) {
            const feedback = document.getElementById('validation-feedback');

            // Show loading state
            feedback.className = 'validation-feedback loading';
            feedback.innerHTML = '<i class="bi bi-hourglass-split"></i> Validating URL...';
            feedback.style.display = 'block';

            fetch('/validate_url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        feedback.className = 'validation-feedback success';
                        feedback.innerHTML = `<i class="bi bi-check-circle-fill"></i> Valid! Title: <strong>${data.title}</strong>`;
                        isUrlValid = true;
                        currentUrl = url;
                    } else {
                        feedback.className = 'validation-feedback error';
                        feedback.innerHTML = `<i class="bi bi-x-circle-fill"></i> ${data.error || 'Invalid URL or unsupported platform'}`;
                        isUrlValid = false;
                    }
                })
                .catch(error => {
                    feedback.className = 'validation-feedback error';
                    feedback.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> Validation failed: ${error.message}`;
                    isUrlValid = false;
                });
        }

        // Function to refresh file list without reloading the page
        function refreshFileList() {
            fetch('/')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Update both header (with Clear All button) and body
                    const newHeader = doc.querySelector('.card:last-child .card-header').innerHTML;
                    const newBody = doc.querySelector('.card:last-child .card-body').innerHTML;

                    document.querySelector('.card:last-child .card-header').innerHTML = newHeader;
                    document.querySelector('.card:last-child .card-body').innerHTML = newBody;
                })
                .catch(error => console.error('Error refreshing file list:', error));
        }

        document.getElementById('download-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const url = document.getElementById('url-input').value.trim();
            const format = document.getElementById('format-select').value;
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const feedback = document.getElementById('validation-feedback');

            // Validate URL before download
            if (!url) {
                feedback.className = 'validation-feedback error';
                feedback.innerHTML = '<i class="bi bi-x-circle-fill"></i> Please enter a URL';
                feedback.style.display = 'block';
                return;
            }

            // Check if URL has been validated
            if (!isUrlValid || currentUrl !== url) {
                feedback.className = 'validation-feedback error';
                feedback.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Please wait for URL validation or enter a valid URL';
                feedback.style.display = 'block';
                return;
            }

            // Hide validation feedback and show progress bar
            feedback.style.display = 'none';
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';

            // Send download request
            fetch('/download_with_progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url, format: format })
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            progressFill.style.width = '100%';
                            progressFill.textContent = '100% - Complete!';
                            setTimeout(() => {
                                // Refresh only the file list, not the whole page
                                refreshFileList();
                                progressContainer.style.display = 'none';
                                document.getElementById('url-input').value = '';
                                isUrlValid = false;
                                currentUrl = '';
                            }, 1500);
                            return;
                        }

                        const text = decoder.decode(value);
                        const lines = text.split('\n');

                        for (let line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6).trim();
                                if (data === 'complete') {
                                    progressFill.style.width = '100%';
                                    progressFill.textContent = '100% - Complete!';
                                    setTimeout(() => {
                                        // Refresh only the file list, not the whole page
                                        refreshFileList();
                                        progressContainer.style.display = 'none';
                                        document.getElementById('url-input').value = '';
                                    }, 1500);
                                } else if (data) {
                                    const percentage = parseFloat(data);
                                    progressFill.style.width = percentage + '%';
                                    progressFill.textContent = percentage.toFixed(1) + '%';
                                }
                            }
                        }

                        readStream();
                    });
                }

                readStream();
            }).catch(error => {
                console.error('Error:', error);
                alert('Download failed. Please try again.');
                progressContainer.style.display = 'none';
            });
        });

        // Function to clear all files
        function clearAllFiles() {
            if (!confirm('Are you sure you want to delete ALL files? This action cannot be undone!')) {
                return;
            }

            fetch('/clear_all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        refreshFileList();
                        alert('All files have been deleted successfully!');
                    } else {
                        alert('Error deleting files: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to delete files. Please try again.');
                });
        }
    </script>
</body>

</html>