<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .file-item {
            transition: transform 0.2s;
        }

        .file-item:hover {
            transform: translateX(5px);
        }

        .progress {
            height: 30px;
            border-radius: 10px;
        }

        .progress-bar {
            font-weight: bold;
            line-height: 30px;
        }

        #progress-container {
            display: none;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Header Card -->
        <div class="card mb-4">
            <div class="card-header text-center">
                <h2 class="mb-0"><i class="bi bi-youtube"></i> YouTube Downloader</h2>
                <p class="mb-0 mt-2">Download videos and audio easily</p>
            </div>
            <div class="card-body p-4">
                <!-- Info Alert -->
                <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <div>
                        <strong>Supports:</strong> Single videos, Playlists, and Channels from YouTube and other platforms
                    </div>
                </div>

                <form id="download-form">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                                <input type="text" id="url-input" name="url" class="form-control" placeholder="Enter video URL..." required>
                            </div>
                        </div>
                        <div class="col-12 col-md-3">
                            <select id="format-select" name="format" class="form-select">
                                <option value="mp4"><i class="bi bi-camera-video"></i> MP4 Video (â‰¤720p)</option>
                                <option value="m4a"><i class="bi bi-music-note"></i> M4A Audio</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-download"></i> Download
                            </button>
                        </div>
                    </div>
                </form>

                <div id="progress-container" class="mt-3">
                    <div class="progress">
                        <div id="progress-fill" class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Files List Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-folder2-open"></i> Downloaded Files</h5>
            </div>
            <div class="card-body">
                {% if files %}
                <div class="list-group">
                    {% for f in files %}
                    <div class="list-group-item file-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center flex-grow-1">
                            <i class="bi bi-file-earmark-play me-3 fs-4 text-primary"></i>
                            <span class="text-break">{{ f }}</span>
                        </div>
                        <div class="btn-group ms-3" role="group">
                            <a href="/download_file/{{ f }}" class="btn btn-success btn-sm" download>
                                <i class="bi bi-download"></i> Download
                            </a>
                            <a href="/delete/{{ f }}" class="btn btn-danger btn-sm" onclick="return confirm('Delete this file?')">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-3">No files downloaded yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('download-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const url = document.getElementById('url-input').value;
            const format = document.getElementById('format-select').value;
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');

            // Show progress bar
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressFill.textContent = '0%';

            // Send download request
            fetch('/download_with_progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: url, format: format })
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            progressFill.style.width = '100%';
                            progressFill.textContent = '100% - Complete!';
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                            return;
                        }

                        const text = decoder.decode(value);
                        const lines = text.split('\n');

                        for (let line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6).trim();
                                if (data === 'complete') {
                                    progressFill.style.width = '100%';
                                    progressFill.textContent = '100% - Complete!';
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                } else if (data) {
                                    const percentage = parseFloat(data);
                                    progressFill.style.width = percentage + '%';
                                    progressFill.textContent = percentage.toFixed(1) + '%';
                                }
                            }
                        }

                        readStream();
                    });
                }

                readStream();
            }).catch(error => {
                console.error('Error:', error);
                alert('Download failed. Please try again.');
                progressContainer.style.display = 'none';
            });
        });
    </script>
</body>

</html>